<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Hunt - NatureHunt</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { font-family: 'Inter', -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: #020617; }
        .glass { background: rgba(255,255,255,0.08); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); }
        .found { opacity: 0.3; pointer-events: none; }
        .rarity-common { border-left: 3px solid #9ca3af; }
        .rarity-uncommon { border-left: 3px solid #22c55e; }
        .rarity-rare { border-left: 3px solid #3b82f6; }
        .rarity-epic { border-left: 3px solid #a855f7; }
        .rarity-legendary { border-left: 3px solid #f59e0b; box-shadow: 0 0 15px rgba(245, 158, 11, 0.3); }
        .toast { animation: slideDown 0.2s ease-out; }
        @keyframes slideDown { from { transform: translateY(-100%); } }
        .pulse { animation: pulse 0.3s ease-out; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
    </style>
</head>
<body class="text-white">
    <!-- Toast -->
    <div id="toast" class="fixed top-4 left-4 right-4 z-[200] hidden toast">
        <div class="glass rounded-xl p-4 text-center font-bold text-lg"></div>
    </div>
    
    <!-- Quick Camera Modal -->
    <div id="camera-modal" class="fixed inset-0 bg-black z-50 hidden">
        <video id="camera" class="w-full h-full object-cover" autoplay playsinline></video>
        <canvas id="canvas" class="hidden"></canvas>
        
        <div class="absolute top-4 left-4 right-4 flex justify-between items-center">
            <button onclick="closeCamera()" class="glass rounded-full w-12 h-12 text-2xl">âœ•</button>
            <div class="glass rounded-full px-4 py-2 font-bold">ğŸ“¸ SNAP IT!</div>
            <div class="w-12"></div>
        </div>
        
        <div class="absolute bottom-20 left-0 right-0 flex justify-center" style="padding-bottom: env(safe-area-inset-bottom);">
            <button onclick="snapPhoto()" class="w-24 h-24 bg-white rounded-full flex items-center justify-center shadow-2xl active:scale-95 transition-transform">
                <div class="w-20 h-20 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-full"></div>
            </button>
        </div>
    </div>
    
    <!-- Identify Modal -->
    <div id="identify-modal" class="fixed inset-0 bg-black/95 z-50 hidden overflow-y-auto">
        <div class="min-h-full p-4" style="padding-bottom: calc(100px + env(safe-area-inset-bottom));">
            <div class="glass rounded-2xl p-4 max-w-md mx-auto">
                <div class="flex justify-between items-center mb-3">
                    <span class="text-lg font-bold">ğŸ¯ What did you find?</span>
                    <button onclick="closeIdentify()" class="text-2xl">âœ•</button>
                </div>
                <img id="snap-preview" class="w-full h-48 object-cover rounded-xl mb-4">
                <div id="id-loading" class="text-center py-6">
                    <div class="text-4xl animate-pulse mb-2">ğŸ”</div>
                    <div>Identifying...</div>
                </div>
                <div id="id-results" class="hidden space-y-2"></div>
            </div>
        </div>
    </div>
    
    <!-- Item Detail Modal -->
    <div id="item-modal" class="fixed inset-0 bg-black/95 z-50 hidden overflow-y-auto">
        <div class="min-h-full p-4" style="padding-bottom: calc(120px + env(safe-area-inset-bottom));">
            <div id="item-detail" class="glass rounded-2xl max-w-md mx-auto overflow-hidden"></div>
        </div>
    </div>
    
    <!-- Header -->
    <div class="glass sticky top-0 z-40 p-3">
        <div class="flex items-center justify-between mb-2">
            <div class="font-bold">ğŸ“ {{ game.biome }}</div>
            <div class="bg-gradient-to-r from-emerald-600 to-teal-600 px-4 py-1.5 rounded-full font-mono font-bold tracking-wider">{{ game.code }}</div>
        </div>
        <div id="leaderboard" class="flex gap-2 overflow-x-auto pb-1">
            {% for p in players %}
            <div class="shrink-0 px-3 py-1 rounded-full text-sm {% if p.name == player_name %}bg-emerald-600/40 border border-emerald-500{% else %}bg-white/10{% endif %}">
                <span class="{% if loop.index == 1 %}text-amber-400{% endif %}">{{ loop.index }}.</span>
                {{ p.name }} <span class="text-emerald-400 font-bold">{{ p.score }}</span>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Category Tabs -->
    <div class="sticky top-[88px] z-30 bg-slate-950/80 backdrop-blur px-3 py-2">
        <div class="flex overflow-x-auto gap-2" id="tabs">
            <button onclick="load('all')" class="shrink-0 px-3 py-1.5 rounded-full text-sm bg-emerald-600/30 border border-emerald-500" data-cat="all">ğŸŒ All</button>
            <button onclick="load('minerals')" class="shrink-0 px-3 py-1.5 rounded-full text-sm bg-white/10" data-cat="minerals">ğŸ’</button>
            <button onclick="load('rocks')" class="shrink-0 px-3 py-1.5 rounded-full text-sm bg-white/10" data-cat="rocks">ğŸª¨</button>
            <button onclick="load('fossils')" class="shrink-0 px-3 py-1.5 rounded-full text-sm bg-white/10" data-cat="fossils">ğŸ¦´</button>
            <button onclick="load('plants')" class="shrink-0 px-3 py-1.5 rounded-full text-sm bg-white/10" data-cat="plants">ğŸŒ¿</button>
            <button onclick="load('birds')" class="shrink-0 px-3 py-1.5 rounded-full text-sm bg-white/10" data-cat="birds">ğŸ¦</button>
            <button onclick="load('tracks')" class="shrink-0 px-3 py-1.5 rounded-full text-sm bg-white/10" data-cat="tracks">ğŸ¾</button>
            <button onclick="load('artifacts')" class="shrink-0 px-3 py-1.5 rounded-full text-sm bg-white/10" data-cat="artifacts">ğŸº</button>
        </div>
    </div>
    
    <!-- Grid -->
    <div class="p-3" style="padding-bottom: calc(140px + env(safe-area-inset-bottom));">
        <div id="grid" class="grid grid-cols-2 gap-2">
            <div class="glass rounded-xl p-8 col-span-2 text-center">
                <div class="text-4xl mb-2 animate-pulse">ğŸ”</div>
                <div>Loading...</div>
            </div>
        </div>
    </div>
    
    <!-- Camera FAB -->
    <div class="fixed z-40" style="bottom: calc(80px + env(safe-area-inset-bottom)); left: 50%; transform: translateX(-50%);">
        <button onclick="openCamera()" class="w-20 h-20 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-full flex items-center justify-center shadow-2xl shadow-emerald-500/40 active:scale-95 transition-transform">
            <span class="text-4xl">ğŸ“¸</span>
        </button>
    </div>
    
    <!-- Bottom Nav -->
    <div class="fixed bottom-0 left-0 right-0 glass z-30" style="padding-bottom: env(safe-area-inset-bottom);">
        <div class="flex p-2 gap-2">
            <a href="/" class="flex-1 py-2.5 bg-white/5 rounded-xl text-center text-xl">ğŸ </a>
            <a href="/reference" class="flex-1 py-2.5 bg-white/5 rounded-xl text-center text-xl">ğŸ“š</a>
            <a href="/collection" class="flex-1 py-2.5 bg-white/5 rounded-xl text-center text-xl">ğŸ†</a>
            <button onclick="share()" class="flex-1 py-2.5 bg-white/5 rounded-xl text-center text-xl">ğŸ“¤</button>
        </div>
    </div>
    
    <script>
        const gameCode = "{{ game.code }}";
        const playerName = "{{ player_name }}";
        const found = new Set({{ found_items | tojson }});
        let lat = {{ lat }}, lng = {{ lng }};
        let stream = null;
        let snap = null;
        
        // GPS tracking
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(p => { lat = p.coords.latitude; lng = p.coords.longitude; }, null, {enableHighAccuracy: true});
        }
        
        // Load items
        async function load(cat) {
            document.querySelectorAll('[data-cat]').forEach(b => {
                b.className = `shrink-0 px-3 py-1.5 rounded-full text-sm ${b.dataset.cat === cat ? 'bg-emerald-600/30 border border-emerald-500' : 'bg-white/10'}`;
            });
            
            const grid = document.getElementById('grid');
            grid.innerHTML = '<div class="glass rounded-xl p-6 col-span-2 text-center"><div class="text-3xl animate-pulse">ğŸ”</div></div>';
            
            try {
                const r = await fetch(`/api/species?lat=${lat}&lng=${lng}&category=${cat}`);
                const data = await r.json();
                
                let items = [];
                for (const [c, list] of Object.entries(data.categories || {})) {
                    list.forEach(i => { i._cat = c; items.push(i); });
                }
                
                if (!items.length) {
                    grid.innerHTML = '<div class="glass rounded-xl p-8 col-span-2 text-center">No items found</div>';
                    return;
                }
                
                // Sort by rarity
                const order = {legendary: 0, epic: 1, rare: 2, uncommon: 3, common: 4};
                items.sort((a,b) => (order[a.rarity]||5) - (order[b.rarity]||5));
                
                grid.innerHTML = items.map(i => {
                    const isFound = found.has(i.name);
                    const emoji = {minerals:'ğŸ’',rocks:'ğŸª¨',fossils:'ğŸ¦´',plants:'ğŸŒ¿',birds:'ğŸ¦',mammals:'ğŸ¦Š',insects:'ğŸ¦‹',fungi:'ğŸ„',tracks:'ğŸ¾',artifacts:'ğŸº'}[i._cat] || 'ğŸ”';
                    return `
                        <div class="glass rounded-xl overflow-hidden rarity-${i.rarity||'common'} ${isFound?'found':''}" onclick='showItem(${JSON.stringify(i).replace(/'/g,"&#39;")})'>
                            ${i.photo ? `<img src="${i.photo}" class="w-full h-24 object-cover" loading="lazy" onerror="this.style.display='none'">` : `<div class="w-full h-24 bg-white/5 flex items-center justify-center text-3xl">${emoji}</div>`}
                            <div class="p-2">
                                <div class="font-medium text-sm truncate">${i.name}</div>
                                <div class="flex justify-between items-center mt-1">
                                    <span class="text-xs text-gray-400 capitalize">${i.rarity||'common'}</span>
                                    <span class="text-xs font-bold text-emerald-400">+${i.points}</span>
                                </div>
                                ${isFound ? '<div class="text-emerald-400 text-xs">âœ“ Found</div>' : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            } catch(e) {
                grid.innerHTML = '<div class="glass rounded-xl p-6 col-span-2 text-center text-red-400">Error loading</div>';
            }
        }
        
        function showItem(item) {
            const modal = document.getElementById('item-modal');
            const detail = document.getElementById('item-detail');
            const emoji = {minerals:'ğŸ’',rocks:'ğŸª¨',fossils:'ğŸ¦´',plants:'ğŸŒ¿',birds:'ğŸ¦',mammals:'ğŸ¦Š',insects:'ğŸ¦‹',fungi:'ğŸ„',tracks:'ğŸ¾',artifacts:'ğŸº'}[item._cat] || 'ğŸ”';
            
            detail.innerHTML = `
                ${item.photo ? `<img src="${item.photo}" class="w-full h-52 object-cover">` : `<div class="w-full h-52 bg-white/5 flex items-center justify-center text-6xl">${emoji}</div>`}
                <div class="p-4">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h2 class="text-xl font-bold">${item.name}</h2>
                            <div class="text-gray-400 text-sm">${item.scientific || item.type || ''}</div>
                        </div>
                        <div class="bg-emerald-600 px-3 py-1 rounded-full font-bold">+${item.points}</div>
                    </div>
                    <p class="text-gray-300 text-sm mb-4">${item.description || ''}</p>
                    <div class="flex gap-2 mb-4">
                        <span class="px-2 py-1 rounded bg-white/10 text-xs capitalize">${item.rarity||'common'}</span>
                        ${item.hardness ? `<span class="px-2 py-1 rounded bg-white/10 text-xs">Hardness: ${item.hardness}</span>` : ''}
                        ${item.period ? `<span class="px-2 py-1 rounded bg-white/10 text-xs">${item.period}</span>` : ''}
                    </div>
                    <div class="flex gap-2">
                        <button onclick="quickLog('${item.name.replace(/'/g,"\\'")}', '${item._cat}', ${item.points})" class="flex-1 py-3 bg-gradient-to-r from-emerald-600 to-teal-600 rounded-xl font-bold">
                            âœ“ LOG FIND
                        </button>
                        <button onclick="closeItem(); openCamera();" class="py-3 px-4 bg-white/10 rounded-xl">ğŸ“¸</button>
                    </div>
                    <button onclick="closeItem()" class="w-full mt-2 py-2 bg-white/5 rounded-xl text-sm">Close</button>
                </div>
            `;
            modal.classList.remove('hidden');
        }
        
        function closeItem() { document.getElementById('item-modal').classList.add('hidden'); }
        
        async function quickLog(name, cat, pts) {
            closeItem();
            toast('ğŸ” Logging...', true);
            
            try {
                const r = await fetch('/api/quick_log', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name, category: cat, points: pts, lat, lng})
                });
                const data = await r.json();
                
                if (data.success) {
                    toast(`ğŸ‰ +${data.points} pts!`, true);
                    found.add(name);
                    document.querySelectorAll(`[onclick*="${name.replace(/'/g,"\\'")}"]`).forEach(el => el.classList.add('found'));
                    refreshLB();
                } else {
                    toast(data.error || 'Error', false);
                }
            } catch(e) {
                toast('Network error', false);
            }
        }
        
        function toast(msg, ok) {
            const t = document.getElementById('toast');
            t.querySelector('div').textContent = msg;
            t.querySelector('div').className = `glass rounded-xl p-4 text-center font-bold text-lg ${ok ? 'bg-emerald-600/30 border border-emerald-500' : 'bg-red-600/30 border border-red-500'}`;
            t.classList.remove('hidden');
            setTimeout(() => t.classList.add('hidden'), 2500);
        }
        
        async function openCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({video: {facingMode: 'environment', width: {ideal: 1280}, height: {ideal: 720}}, audio: false});
                document.getElementById('camera').srcObject = stream;
                document.getElementById('camera-modal').classList.remove('hidden');
            } catch(e) {
                toast('Camera access needed!', false);
            }
        }
        
        function closeCamera() {
            if (stream) stream.getTracks().forEach(t => t.stop());
            document.getElementById('camera-modal').classList.add('hidden');
        }
        
        function snapPhoto() {
            const video = document.getElementById('camera');
            const canvas = document.getElementById('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            snap = canvas.toDataURL('image/jpeg', 0.7);
            closeCamera();
            identify();
        }
        
        async function identify() {
            const modal = document.getElementById('identify-modal');
            document.getElementById('snap-preview').src = snap;
            document.getElementById('id-loading').classList.remove('hidden');
            document.getElementById('id-results').classList.add('hidden');
            modal.classList.remove('hidden');
            
            try {
                const r = await fetch('/api/identify', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({image: snap, lat, lng})
                });
                const data = await r.json();
                
                document.getElementById('id-loading').classList.add('hidden');
                const results = document.getElementById('id-results');
                
                if (data.results && data.results.length) {
                    results.innerHTML = data.results.map(r => `
                        <div class="glass rounded-xl p-3 active:bg-emerald-600/20" onclick="confirmFind('${r.name.replace(/'/g,"\\'")}', '${r.category||'Unknown'}', ${r.points||50})">
                            <div class="flex gap-3 items-center">
                                ${r.photo ? `<img src="${r.photo}" class="w-14 h-14 rounded-lg object-cover">` : '<div class="w-14 h-14 bg-white/10 rounded-lg flex items-center justify-center">ğŸ”</div>'}
                                <div class="flex-1">
                                    <div class="font-bold">${r.name}</div>
                                    <div class="text-xs text-gray-400">${Math.round(r.score * 100)}% match</div>
                                </div>
                                <div class="text-emerald-400 font-bold">+${r.points||50}</div>
                            </div>
                        </div>
                    `).join('');
                    results.classList.remove('hidden');
                } else {
                    results.innerHTML = `
                        <div class="text-center py-4">
                            <div class="text-3xl mb-2">ğŸ¤”</div>
                            <div class="mb-3">Couldn't identify. Check the Reference Guide!</div>
                            <a href="/reference" class="inline-block px-4 py-2 bg-emerald-600 rounded-lg">ğŸ“š Reference</a>
                        </div>
                    `;
                    results.classList.remove('hidden');
                }
            } catch(e) {
                document.getElementById('id-loading').classList.add('hidden');
                document.getElementById('id-results').innerHTML = '<div class="text-center text-red-400">Error - try again</div>';
                document.getElementById('id-results').classList.remove('hidden');
            }
        }
        
        async function confirmFind(name, cat, pts) {
            closeIdentify();
            toast('ğŸ” Confirming...', true);
            
            try {
                const r = await fetch('/api/confirm_find', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name, category: cat, points: pts, lat, lng})
                });
                const data = await r.json();
                
                if (data.success) {
                    toast(`ğŸ‰ ${name}! +${data.points} pts!`, true);
                    found.add(name);
                    refreshLB();
                } else {
                    toast(data.error || 'Error', false);
                }
            } catch(e) {
                toast('Network error', false);
            }
        }
        
        function closeIdentify() { document.getElementById('identify-modal').classList.add('hidden'); }
        
        async function refreshLB() {
            const r = await fetch(`/api/leaderboard/${gameCode}`);
            const players = await r.json();
            document.getElementById('leaderboard').innerHTML = players.map((p,i) => `
                <div class="shrink-0 px-3 py-1 rounded-full text-sm ${p.name === playerName ? 'bg-emerald-600/40 border border-emerald-500' : 'bg-white/10'}">
                    <span class="${i === 0 ? 'text-amber-400' : ''}">${i+1}.</span>
                    ${p.name} <span class="text-emerald-400 font-bold">${p.score}</span>
                </div>
            `).join('');
        }
        
        function share() {
            const text = `Join my NatureHunt! Code: ${gameCode}`;
            if (navigator.share) navigator.share({title: 'NatureHunt', text, url: location.origin + '/join'});
            else { navigator.clipboard.writeText(text); toast('Code copied!', true); }
        }
        
        load('all');
        setInterval(refreshLB, 5000);
    </script>
</body>
</html>
